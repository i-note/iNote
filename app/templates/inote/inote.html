{%- extends "inote/inote_base.html" %}

{% block styles -%}
    {{super()}}
    <link rel="stylesheet" type="text/css"
          href="{{url_for('static', filename='style/base.css')}}">
    <link rel="stylesheet" href="/static/style/jquery.resizableColumns.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.2.3/jquery.contextMenu.min.css" />
    <link rel="stylesheet" href="http://wwwendt.de/tech/fancytree//src/skin-win8/ui.fancytree.css">
<!--
<style type="text/css">
	#draggableSample, #droppableSample {
	height:100px;
	padding:0.5em;
	width:150px;
	border:1px solid #AAAAAA;
	}
	#draggableSample {
	background-color: silver;
	color:#222222;
	}
	#droppableSample {
	background-color: maroon;
	color: white;
	}
	#droppableSample.drophover {
	border: 1px solid green;
	}
	#droppableSample.drophover {
	border: 1px solid green;
	}
	span.drag-source {
	border: 1px solid grey;
	border-radius: 3px;
	padding: 2px;
	background-color: silver
	}

	ul.fancytree-container {
	max-height: 200px;
	overflow-y: scroll;
	}

	span.fancytree-node.fancytree-drag-source {
	outline: 1px dotted grey;
	}

	span.fancytree-node.fancytree-drop-accept {
	outline: 1px dotted green;
	}
	span.fancytree-node.fancytree-drop-reject {
	outline: 1px dotted red;
	}

</style>
-->

{% endblock %}

{% block inote %}

    <table class=" table-bordered" style="width:100%">
        <thead>
            <tr height="50px">
                <th width="20%">category</th>
                <th width="20%">item</th>
                <th>inote</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td valign="top">
                    <div id="category" class="autoScroll">
                        <div id="tree"></div>
                    </div>
                </td>
                <td valign="top">
                    <div id="item" class="autoScroll">
                        <div id="list"></div>
                    </div>
                </td>
                <td valign="top">
                    <div id="content" class="autoScroll">
                        <div id="editor"></div>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>

{% block scripts %}

    {{super()}}

    <script src="/static/js/colResizable-1.6.min.js"></script>
	<script src="http://wwwendt.de/tech/fancytree//src/jquery.fancytree.js"></script>
	<script src="http://wwwendt.de/tech/fancytree//src/jquery.fancytree.dnd5.js"></script>
	<script src="http://wwwendt.de/tech/fancytree//src/jquery.fancytree.edit.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.2.3/jquery.contextMenu.min.js"></script>
	<script src="http://wwwendt.de/tech/fancytree/3rd-party/extensions/contextmenu/js/jquery.fancytree.contextMenu.js"></script>

    <script>

        $(function(){
            $("table").colResizable();
        });

        $("#category").height($(window).height()-$("#category").position().top-1);
        $("#item").height($(window).height()-$("#item").position().top-1);
        $("#content").height($(window).height()-$("#content").position().top-1);

        $(window).resize(function () {
            $("#category").height($(window).height()-$("#category").position().top-1);
            $("#item").height($(window).height()-$("#item").position().top-1);
            $("#content").height($(window).height()-$("#content").position().top-1);
        });

	function lazyLoad(event, data) {
		console.log("category/"+data.node.key)
		data.result = {
		    method:'GET',
		    url:"category",
		    data:{'id':'-1'},
		    dataType: "json",
		    contentType: "application/json; charset=utf-8",
            success:function(data){
                console.log(data)
            },
		};
	}

	function loadError(e,data) {
		var error = data.error;
		if (error.status && error.statusText) {
			data.message = "Ajax error: " + data.message;
			data.details = "Ajax error: " + error.statusText + ", status code = " + error.status;
		} else {
			data.message = "Custom error: " + data.message;
			data.details = "An error occurred during loading: " + error;
		}
	}

	$(function(){
		$("#tree").fancytree({
			extensions: ["dnd5","edit","contextMenu"],
			source: $.ajax({
		    method:'get',
		    url:"category",
		    data:{'id':'-1'},
		    dataType: "json",
		    contentType: "application/json; charset=utf-8",
		}),
			contextMenu: {
				menu: {
					"add": { "name": "Add", "icon": "add" },
					"rename": { "name": "Rename", "icon": "edit" },
					"delete": { "name": "Delete", "icon": "delete" },
					"sep1": "---------",
					"reload": { "name": "Reload", "icon": "reload" },
					"sep2": "---------",
					"public": {
						"name": "Public",
						"items": {
							"public_as_blog": { "name": "Public as blog" },
							"cancel_public": { "name": "Cancel public" },
						}
					},
					"share": {
						"name": "Share",
						"items": {
							"share_to_qq": { "name": "QQ" },
							"share_to_wechat": { "name": "wechat" },
							"share_to_sina": { "name": "sina" }
						}
					}
				},
				actions: function(node, action, options) {
					console.log("Selected '" + action + "' on " + node);
					if (action == 'add') {
						// add
						node.editCreateNode("child", "Node title");
					}else if (action == 'delete') {
						// delete
                        var node = $("#tree").fancytree("getActiveNode");
						node.remove();
					}else if (action == 'rename') {
						// rename
                        $('#'+$("#tree").fancytree("getActiveNode").li.id).dblclick();
					}
				}
			},

			ajax: { debugDelay: 1000 },
			lazyLoad: lazyLoad,
			loadError: loadError,

			createNode: function(event, data) {
				console.log(event, data);
			},

			//
			modifyChild: function(event, data) {
				if (data.operation == 'remove') {console.log('delete: ',data.node)}
				console.log(event, data, "operation=" + data.operation + ", child=" + data.childNode);
			},
			//
			focus: function(event, data) {
				console.log(event, data);
			},
			//
			keydown: function(event, data) {
				console.log('keydown: ',event.which);
				switch( event.which ) {
					case 32: // [space]
						data.node.toggleSelected();
						break;
					case 46: // [delete]
						var node = $("#tree").fancytree("getActiveNode");
						node.remove();

						break;
					case 116: // [F5]

						break;
					case 78: // [n]
						data.node;
						break;
				}
				return false;
			},
			dnd5: {
				dragStart: function(node, data) {
					return true;
				},
				dragDrag: function(node, data) {
					data.dataTransfer.dropEffect = "move";
				},
				dragEnd: function(node, data) {
				},
				dragEnter: function(node, data) {
					data.dataTransfer.dropEffect = "move";
					return true;
				},
				dragOver: function(node, data) {
					data.dataTransfer.dropEffect = "move";
				},
				dragLeave: function(node, data) {
				},
				dragDrop: function(node, data) {
					var transfer = data.dataTransfer;
					if( data.otherNode ) {
						var sameTree = (data.otherNode.tree === data.tree);
						data.otherNode.moveTo(node, data.hitMode);
					} else if( data.otherNodeData ) {
						node.addChild(data.otherNodeData, data.hitMode);
					} else {
						node.addNode({
							title: transfer.getData("text")
						}, data.hitMode);
					}
					node.setExpanded();
				}
			},
			edit: {
				triggerStart: ["f2", "dblclick", "shift+click", "mac+enter"],
				beforeEdit: function(event, data){
				},
                edit: function(event, data){
                },
                beforeClose: function(event, data){
                    console.log(event.type, event, data);
                    if( data.originalEvent.type === "mousedown" ) {
                    }
                },
                save: function(event, data){
                    setTimeout(function(){
                        $(data.node.span).removeClass("pending");
                        data.node.setTitle(data.node.title + "!");
                    }, 2000);
                    return true;
                },
                close: function(event, data){
                    if( data.save ) {
                        $(data.node.span).addClass("pending");
                    }
                }
			},
			activate: function(event, data) {
				console.log(data.node)
			},
			tooltip: function(event, data) {
				return data.node.title;
			},
			icon: function(event, data) {
				var node = data.node;
				if( node.data.children === null ) {
					return "foo-icon-class";
			    }
			},
		});
	});

    </script>

{%- endblock scripts %}


{% endblock %}